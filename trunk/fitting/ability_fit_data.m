clear

%% 28a - CS, HotR, Censure, SoT, Melee

%STR AP SP haste hit crit exp
stats=...
 [3804 7858 3929 0 1.73 6.16 1.08; %data set in error, exclude
  5192 10634 5397 1.07 1.73 6.16 3.31; %AP & SP don't match, sp in error?
  6720 13690 6720 3.38 1.73 6.97 3.31; %AP & SP don't match, sp in error?
  8170 16590 8295 3.38 2.87 8.14 3.31;
  9819 19885 9944 4.51 2.87 9.60 3.31;
  176 602 301 0 0 5.01 0;
  1624 3498 1749 0 0 5.36 2.55;
  2953 6156 3078 0.76 0.62 5.36 3.89;...
  4481 9212 4606 3.07 0.62 6.30 3.89;...
  5931 12112 6056 3.07 1.97 7.31 3.89;...%note: hunter's mark on target possibly
  7580 15410 7705 4.40 1.97 8.53 3.89;...%filtered to eliminate hostile debuffs
  8690 17630 8815 4.40 3.37 8.53 3.89;...
  10566 21382 10691 0 0 0 0];  

ap=stats(:,2);sp=stats(:,3);

winfo.name='Club';
winfo.speed=1.9;
winfo.min=3;
winfo.max=6;
winfo.mean=4.5;
winfo.dps=2.3;

%ability data

cs.num=[48 77 92 76 84 44 58 39 54 43 53 57 67];
cs.dmg = ...    %id=35395
    [8128 11050.6 13001;...
     8616 11446.3 13463;...
     9336 11788.7 14045;...
     10142 12964.6 15193;...
     10713 13409.2 15790;...
     842 843.2 845;...
     1358 1359.7 1362;...
     1832 1834.2 1836;...
     2378 2379.3 2381;...
     3040 3041.9 3044;...
     3658 3659.8 3661;...
     4074 4075.7 4077;...
     4777 4778.7 4780];

hotr.num=[58 82 80 84 85 45 65 39 59 47 45 53 57];
hotr.dmg = ...    %id=53595
    [938 1241.2 1538;...
     993 1314.2 1619;...
     1078 1368.5 1692;...
     1143 1458.7 1761;...
     1221 1539.2 1844;...
     11 11.4 12;...
     62 62.4 63;...
     109 109.3 110;...
     163 163.3 164;...
     214 214.5 215;...
     272 272.9 273;...
     312 311.9 313;...
     378 378.2 379];
 
hanova.num = [114 176 177 178 176 51 73 41 68 49 55 60 68];
hanova.dmg = ...   %id=88263
    [2603 2873.3 3086;... %[2686 ? 3098] for lvl 85 dummy
     3339 3534.9 3747;... %[3333 ? 3747] for level 85
     4045 4251.0 4456;...
     4734 4932.5 5142;... %[4723 ? 5142] for level 85
     5495 5748.5 5915;... %[5496 ? 6199] for level 85
     992 1206.0 1402;...
     1660 1873.1 2070;...
     2287 2520.2 2688;...
     2997 3193.3 3414;...
     3690 3878.1 4092;...
     4471 4681.1 4864;...
     4971 5181.5 5386;...
     5847 6058.3 6260];   

sot.num=[310 468 495 475 517 414 587 411 549 485 473 547 565];
sot.dmg = ...    %id=42463
    [995 1326.9 1671;...
     1069 1411.6 1743;...
     1148 1485.0 1823;...
     1222 1549.3 1900;...
     1310 1638.7 1982;...
     12 12.1 13;...
     67 67.1 68;...
     117 117.6 118;...
     175 175.7 176;...
     230 231.0 231;...
     293 293.4 294;...
     335 335.6 336;...
     406 406.9 407];
 
cens.num=[207 314 332 328 376 233 330 218 291 267 234 289 296];
cens.dmg = ...   %id=31803
    [3377 3485.8 3501;... %3501 most of the time, drops for the last 10 ticks or so?
     4458 4441.7 4459;...
     5513 5489.8 5514;...
     6513 6501.6 6514;...
     7651 7631.1 7652;...
     997 997.7 998;...
     1996 1992.0 1997; ...
     2913 2897.8 2914;...
     3968 3957.2 3969;...
     4968 4938.9 4969;...
     6106 6106.5 6107;...
     6872 6853.4 6873;...
     8166 8166.8 8167];
 
melee.num=[118 188 179 198 212 171 252 184 224 208 196 252 239]; 
melee.dmg = ...  %id=0
    [3167 6129.0 7776;...
     3258 6566.9 8078;...
     3598 6897.4 8481;...
     3920 7271.3 8816;...
     4235 7690.2 9214;...
     36 56.1 57;...     %note: oddity in melee data from here on
     205 311.8 313;...  %note: oddity in this data
     355 546.5 548;...  %note: oddity in this data
     533 816.4 818;...
     700 1074.2 1127;...
     889 1363.7 1365;...
     1021 1559.7 1561;...
     1232 1890.9 1892];
 
jud.num=[99 90 105 97 92 64 97 58 79 68 72 85 89];
jud.dmg = ...  %id=20271
    [6057 6057.9 6058;...
     8300 8300.0 8300;...
     10483 10483.5 10484;...
     12555 12555.5 12556;...
     14912 14912.0 14912;...
     1132 1132.1 1133;...
     3201 3201.4 3202;...
     5100 5100.3 5101;...
     7284 7284.0 7284;...
     9356 9356.0 9357;...
     11712 11712.5 11713;...
     13298 13298.6 13299;...
     15979 15979.5 15980];
 
hw.num=[52 42 34 48 46 35 67 20 34 45 31 28 50];
hw.dmg = ...  %id=119072
    [7711 7711.8 7712;...
     9139 9139.6 9140;...
     10530 10530.0 10530;...
     11849 11849.4 11850;...
     13350 13350.0 13350;...
     4574 4574.9 4575;...
     5892 5892.6 5893;...
     7101 7101.9 7102;...
     8492 8492.6 8493;...
     9812 9812.0 9812;...
     11312 11312.5 11313;...
     12322 12322.7 12323;...
     14029 14029.9 14030];
 
as.num=[35 34 34 34 36 40 67 33 48 47 45 47 57];
as.dmg = ...  %id=31935
    [9033 9423.1 9798;...
     10954 11395.0 11763;...
     12941 13393.7 13818;...
     14825 15238.2 15694;...
     16974 17341.7 17859;...
     4472 4893.8 5276;...
     6322 6738.4 7184;...
     8044 8581.8 8919;...
     10027 10426.3 10921;...
     11952 12368.0 12805;...
     14084 14568.4 14916;...
     15542 15907.0 16356;...
     17939 18400.7 18829];

cons.num=[553 470 587 563 541 381 673 268 417 456 320 579 611];
cons.dmg = ...  %id=81297
    [518 518.7 519;...
     707 707.0 707;...
     890 890.4 891;...
     1064 1064.4 1065;...
     1262 1262.3 1263;...
     105 105.1 106;...
     278 278.9 279;...
     439 438.4 439;...
     621 621.7 622;...
     795 795.7 796;...
     993 993.6 994;...
     1126 1126.8 1127;...
     1351 1351.9 1352];

sotr.num=[38 33 36 34 34 62 95 53 81 57 77 79 84];
sotr.dmg = ...  %id=53600
    [4664 4664.8 4665;...
     6359 6359.2 6360;...
     8009 8009.7 8010;...
     9575 9575.6 9576;...
     11356 11356.7 11357;...
     942 942.1 943;...
     2505 2505.9 2506;...
     3941 3941.3 3942;...
     5591 5591.5 5592;...
     7157 7157.4 7158;...
     8938 8938.4 8939;...
     10137 10137.2 10138;...
     12163 12163.3 12164];

% sot2.num=[263 241 279 271 244];
% sot2.dmg = ...  %id=42463
%     [987 1331.7 1657;...
%      1067 1411.0 1742;...
%      1148 1479.9 1818;...
%      1224 1563.9 1891;...
%      1308 1621.4 1984];
% 
% cens2.num=[218 207 236 219 198];
% cens2.dmg = ...  %id=31803
%     [3376 3376.2 3377;...
%      4458 4445.8 4459;...
%      5513 5499.1 5514;...
%      6513 6483.8 6514;...
% %      7651 7651.4 7652];
% 
% melee2.num=[221 214 246 231 211];
% melee2.dmg = ...  %id=0
%     [5698 7693.1 9566;...
%      6166 8080.9 10041;...
%      6673 8590.8 10508;...
%      7047 8999.6 10932;...
%      7543 9465.6 11435];

%expression editor string:
%sourceName ="Klaudandus" and spellID =0 and type=1 and isCritical=false and blocked=0 and (amount <4300 or amount >9200)

%% L93 armor calculations
data=[10038 890; 10492 930; 10974 973; 11504 1019; 12010 1064; 12500 1108; 13008 1152; 13512 1197; 13930 1233; 14520 1285; 15014 1329; 15518 1374; 15992 1415; 16572 1466];
l93_ap=data(:,1);l93_maxd=data(:,2);
l93_maxwd=winfo.max+l93_ap./14.*winfo.speed;

%% Fitting
%skip data set 1, since it's in error
k=2:size(stats,1);
sp_fixed=ap(k)./2;
%for weapon damage based sets, skip 1-5 as they used a different weapon
kw=6:size(stats,1);


wdmin=winfo.min+ap(kw)./14.*winfo.speed;
wdmax=winfo.max+ap(kw)./14.*winfo.speed;
wdmean=winfo.mean+ap(kw)./14.*winfo.speed;
ndmin=winfo.min+ap(kw)./14.*2.4;
ndmax=winfo.max+ap(kw)./14.*2.4;
ndmean=winfo.mean+ap(kw)./14.*2.4;

%melee
%expected: a*x, where a is the phys damage reduction coeff
%fit form: a*x
melee_min=melee.dmg(kw,1);
melee_mean=melee.dmg(kw,2);
melee_max=melee.dmg(kw,3);
melee_ft=fittype('a*x');
melee_fo=fitoptions('Method','NonlinearLeastSquares','StartPoint',[0.91]);
[melee_fit melee_gof]=fit(wdmax,melee_max,melee_ft,melee_fo)

%CS
%expected based on tooltip:
%160% norm weapon damage + 1123
%fit form: a*w*0.6545
cs_min=cs.dmg(kw,1);
cs_mean=cs.dmg(kw,2);
cs_max=cs.dmg(kw,3);
cs_ft=fittype('0.6504*(a*x+b)');
cs_fo = fitoptions('Method','NonlinearLeastSquares','StartPoint',[0.91 4300]);
[cs_fit cs_gof] = fit(ndmax,cs_max,cs_ft,cs_fo)

%HotR
%expected based on tooltip:
%20% weapon damage
%fit form: a*w*0.6545
hotr_min=hotr.dmg(kw,1);
hotr_mean=hotr.dmg(kw,2);
hotr_max=hotr.dmg(kw,3);
hotr_ft=fittype('0.6504*a*x');
hotr_fo = fitoptions('Method','NonlinearLeastSquares','StartPoint',[0.2]);
[hotr_fit hotr_gof] = fit(wdmax,hotr_max,hotr_ft,hotr_fo)

%HammerNova
%expected based on tooltip:
%(840-1261)+0.234*AP
%fit form: a*x+b, expect a=46.8, b=1050
hanova_min=hanova.dmg(k,1);
hanova_mean=hanova.dmg(k,2);
hanova_max=hanova.dmg(k,3);
hanova_ft=fittype('a*x+b');
hanova_fo = fitoptions('Method','NonlinearLeastSquares','StartPoint',[0.468 1050]);
[hanova_fit hanova_gof] = fit(sp_fixed,hanova_max,hanova_ft,hanova_fo)
[hanova_fit2 hanova_gof2] = fit(sp_fixed,hanova_min,hanova_ft,hanova_fo)

%SoT
%expected based on tooltip:
%14% weapon damage
%fit form: a*x, expect a=0.14
sot_min=sot.dmg(kw,1);
sot_mean=sot.dmg(kw,2);
sot_max=sot.dmg(kw,3);
sot_ft=fittype('a*x');
sot_fo = fitoptions('Method','NonlinearLeastSquares','StartPoint',[0.14]);
[sot_fit sot_gof] = fit(wdmean,sot_mean,sot_ft,sot_fo)


%censure
%expected based on tooltip: 
%(158+0.138*sp)*5 = 790 + 0.69*sp
%fit form ax+b, expect a=0.69 b=790
cens_min=cens.dmg(k,1);
cens_mean=cens.dmg(k,2);
cens_max=cens.dmg(k,3);
cens_ft=fittype('a*x+b');
cens_fo = fitoptions('Method','NonlinearLeastSquares','StartPoint',[0.69 790]);
[cens_fit cens_gof] = fit(sp_fixed,cens_max,cens_ft,cens_fo)

%judgment
%expected based on tooltip:
%702+0.397*ap+0.635*sp = 702+1.429*sp
%fit form 702+ax+b, expect a=1.429, b=0;
j_min=jud.dmg(k,1);
j_mean=jud.dmg(k,2);
j_max=jud.dmg(k,3);
j_ft=fittype('702+a*x+b');
j_fo = fitoptions('Method','NonlinearLeastSquares','StartPoint',[2*0.397+0.635 0]);
[j_fit j_gof] = fit(sp_fixed,j_mean,j_ft,j_fo)

%holy wrath
%expected based on tooltip: 4300+0.91*sp
%fit form ax+b, expecct a=0.91 b=4300
hw_min=hw.dmg(k,1);
hw_mean=hw.dmg(k,2);
hw_max=hw.dmg(k,3);
hw_ft=fittype('a*x+b');
hw_fo = fitoptions('Method','NonlinearLeastSquares','StartPoint',[0.91 4300]);
[hw_fit hw_gof] = fit(sp_fixed,hw_mean,hw_ft,hw_fo)

%consecration
%no useful tooltip data, using cata formula for start point
%note that we're fitting ticks, x10 for full cast
cons_min=cons.dmg(k,1);
cons_mean=cons.dmg(k,2);
cons_max=cons.dmg(k,3);
cons_ft=fittype('a*x+b');
cons_fo = fitoptions('Method','NonlinearLeastSquares','StartPoint',[0.27*3/10 813/10]);
[cons_fit cons_gof] = fit(sp_fixed,cons_mean,cons_ft,cons_fo)

%Avenger's Shield
%expected based on tooltip: (4039-4937)+0.21*sp+0.545*ap
%fit form: a*x+b, b=4937 or 4039, a=0.21+2*0.545
as_min=as.dmg(k,1);
as_mean=as.dmg(k,2);
as_max=as.dmg(k,3);
as_ft=fittype('a*x+b');
as_fo = fitoptions('Method','NonlinearLeastSquares','StartPoint',[1.30 4500]);
[as_fit as_gof] = fit(sp_fixed,as_min,as_ft,as_fo)
[as_fit2 as_gof2] = fit(sp_fixed,as_max,as_ft,as_fo)


%sotr
%expected based on tooltip:
%617 + 0.54*ap = 617 + 1.08*sp
%fit form ax+b, expect a=1.08 b=617
sotr_min=sotr.dmg(k,1);
sotr_mean=sotr.dmg(k,2);
sotr_max=sotr.dmg(k,3);
sotr_ft=fittype('a*x+b');
sotr_fo = fitoptions('Method','NonlinearLeastSquares','StartPoint',[1.08 617]);
[sotr_fit sotr_gof] = fit(sp_fixed,sotr_mean,sotr_ft,sotr_fo)


% x_min=x.dmg(k,1);
% x_mean=x.dmg(k,2);
% x_max=x.dmg(k,3);
% x_ft=fittype('a*x+b');
% x_fo = fitoptions('Method','NonlinearLeastSquares','StartPoint',[0.91 4300]);
% [x_fit x_gof] = fit(sp_fixed,x_mean,x_ft,x_fo)